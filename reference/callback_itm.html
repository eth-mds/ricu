<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Item callback utilities — transform_fun • ICU data with R</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Item callback utilities — transform_fun"><meta property="og:description" content="For concept loading, item callback functions are used in order to handle
item-specific post-processing steps, such as converting measurement units,
mapping a set of values to another or for more involved data
transformations, like turning absolute drug administration rates into rates
that are relative to body weight. Item callback functions are called by
load_concepts() with arguments x (the data), a variable number of name/
string pairs specifying roles of columns for the given item, followed by
env, the data source environment as src_env object.
Item callback functions can be specified by their name or using function
factories such as transform_fun(), apply_map() or convert_unit()."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ICU data with R</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/ricu.pdf">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/start.html">Quick start guide</a>
    </li>
    <li>
      <a href="../articles/uom.html">Units of measurement</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/eth-mds/ricu" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Item callback utilities</h1>
    
    <div class="hidden name"><code>callback_itm.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>For concept loading, item callback functions are used in order to handle
item-specific post-processing steps, such as converting measurement units,
mapping a set of values to another or for more involved data
transformations, like turning absolute drug administration rates into rates
that are relative to body weight. Item callback functions are called by
<code><a href="load_concepts.html">load_concepts()</a></code> with arguments <code>x</code> (the data), a variable number of name/
string pairs specifying roles of columns for the given item, followed by
<code>env</code>, the data source environment as <code><a href="src_env.html">src_env</a></code> object.
Item callback functions can be specified by their name or using function
factories such as <code>transform_fun()</code>, <code>apply_map()</code> or <code>convert_unit()</code>.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">transform_fun</span><span class="op">(</span><span class="va">fun</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">binary_op</span><span class="op">(</span><span class="va">op</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">comp_na</span><span class="op">(</span><span class="va">op</span>, <span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">set_val</span><span class="op">(</span><span class="va">val</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">apply_map</span><span class="op">(</span><span class="va">map</span>, var <span class="op">=</span> <span class="st">"val_var"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">convert_unit</span><span class="op">(</span><span class="va">fun</span>, <span class="va">new</span>, rgx <span class="op">=</span> <span class="cn">NULL</span>, ignore_case <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>fun</dt>
<dd><p>Function(s) used for transforming matching values</p></dd>


<dt>...</dt>
<dd><p>Further arguments passed to downstream function</p></dd>


<dt>op</dt>
<dd><p>Function taking two arguments, such as <code>+</code></p></dd>


<dt>y</dt>
<dd><p>Value passed as second argument to function <code>op</code></p></dd>


<dt>val</dt>
<dd><p>Value to replace every element of x with</p></dd>


<dt>map</dt>
<dd><p>Named atomic vector used for mapping a set of values (the names
of <code>map</code>) to a different set (the values of <code>map</code>)</p></dd>


<dt>var</dt>
<dd><p>Argument which is used to determine the column the mapping is
applied to</p></dd>


<dt>new</dt>
<dd><p>Name(s) of transformed units</p></dd>


<dt>rgx</dt>
<dd><p>Regular expression(s) used for identifying observations based on
their current unit of measurement, <code>NULL</code> means everything</p></dd>


<dt>ignore_case</dt>
<dd><p>Forwarded to <code><a href="https://rdrr.io/r/base/grep.html" class="external-link">base::grep()</a></code></p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>Callback function factories such as <code>transform_fun()</code>, <code>apply_map()</code></p>


<p>or <code>convert_unit()</code> return functions suitable as item callback functions,
while transform function generators such as <code>binary_op()</code>, <code>comp_na()</code></p>


<p>return functions that apply a transformation to a vector.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>The most forward setting is where a function is simply referred to by its
name. For example in eICU, age is available as character vector due to
ages 90 and above being represented by the string "&gt; 89". A function such
as the following turns this into a numeric vector, replacing occurrences of
"&gt; 89" by the number 90.</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>eicu_age <span class="ot">&lt;-</span> <span class="cf">function</span>(x, val_var, ...) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  data.table<span class="sc">::</span><span class="fu">set</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    data.table<span class="sc">::</span><span class="fu">set</span>(x, <span class="fu">which</span>(x[[val_var]] <span class="sc">==</span> <span class="st">"&gt; 89"</span>), <span class="at">j =</span> val_var,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">value =</span> <span class="dv">90</span>),</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">j =</span> val_var,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">as.numeric</span>(x[[val_var]])</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre><p></p></div>
<p>This function then is specified as item callback function for items
corresponding to eICU data sources of the <code>age</code> concept as</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">item</span>(<span class="at">src =</span> <span class="st">"eicu_demo"</span>, <span class="at">table =</span> <span class="st">"patient"</span>, <span class="at">val_var =</span> <span class="st">"age"</span>,</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">callback =</span> <span class="st">"eicu_age"</span>, <span class="at">class =</span> <span class="st">"col_itm"</span>)</span></code></pre><p></p></div>
<p>The string passed as <code>callback</code> argument is evaluated, meaning that an
expression can be passed which evaluates to a function that in turn can be
used as callback. Several function factories are provided which return
functions suitable for use as item callbacks: <code>transform_fun()</code> creates a
function that transforms the <code>val_var</code> column using the function supplied
as <code>fun</code> argument, <code>apply_map()</code> can be used to map one set of values to
another (again using the <code>val_var</code> column) and <code>convert_unit()</code> is intended
for converting a subset of rows (identified by matching <code>rgx</code> against the
<code>unit_var</code> column) by applying <code>fun</code> to the <code>val_var</code> column and setting
<code>new</code> as the transformed unit name (arguments are not limited to scalar
values). As transformations require unary functions, two utility function,
<code>binary_op()</code> and <code>comp_na()</code> are provided which can be used to fix the
second argument of binary functions such as <code>*</code> or <code>==</code>. Taking all this
together, an item callback function for dividing the <code>val_var</code> column by 2
could be specified as <code>"transform_fun(binary_op(</code>/<code>, 2))"</code>. The supplied
function factories create functions that operate on the data using
by-reference semantics. Furthermore, during concept
loading, progress is reported by a <a href="https://rdrr.io/pkg/progress/man/progress_bar.html" class="external-link">progress::progress_bar</a>. In order to
signal a message without disrupting the current loading status, see
<code><a href="cli_output.html">msg_progress()</a></code>.</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="id_tbl.html">ts_tbl</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="difftime.html">hours</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, z <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">subtract_3</span> <span class="op">&lt;-</span> <span class="fu">transform_fun</span><span class="op">(</span><span class="fu">binary_op</span><span class="op">(</span><span class="va">`-`</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">subtract_3</span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, val_var <span class="op">=</span> <span class="st">"z"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     x       y  z</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1: 1 1 hours -2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  2: 1 2 hours -1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  3: 1 3 hours  0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  4: 1 4 hours  1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  5: 1 5 hours  2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  6: 2 1 hours  3</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  7: 2 2 hours  4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  8: 2 3 hours  5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  9: 2 4 hours  6</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10: 2 5 hours  7</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">gte_4</span> <span class="op">&lt;-</span> <span class="fu">transform_fun</span><span class="op">(</span><span class="fu">comp_na</span><span class="op">(</span><span class="va">`&gt;=`</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">gte_4</span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, val_var <span class="op">=</span> <span class="st">"z"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     x       y     z</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1: 1 1 hours FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  2: 1 2 hours FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  3: 1 3 hours FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  4: 1 4 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  5: 1 5 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  6: 2 1 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  7: 2 2 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  8: 2 3 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  9: 2 4 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10: 2 5 hours  TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">map_letters</span> <span class="op">&lt;-</span> <span class="fu">apply_map</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">]</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">map_letters</span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, val_var <span class="op">=</span> <span class="st">"z"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">res</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     x       y    z</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1: 1 1 hours    a</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  2: 1 2 hours    b</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  3: 1 3 hours    c</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  4: 1 4 hours    d</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  5: 1 5 hours    e</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  6: 2 1 hours    f</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  7: 2 2 hours    g</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  8: 2 3 hours    h</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  9: 2 4 hours    i</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10: 2 5 hours &lt;NA&gt;</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">not_b</span> <span class="op">&lt;-</span> <span class="fu">transform_fun</span><span class="op">(</span><span class="fu">comp_na</span><span class="op">(</span><span class="va">`!=`</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">not_b</span><span class="op">(</span><span class="va">res</span>, val_var <span class="op">=</span> <span class="st">"z"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     x       y     z</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  1: 1 1 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  2: 1 2 hours FALSE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  3: 1 3 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  4: 1 4 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  5: 1 5 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  6: 2 1 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  7: 2 2 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  8: 2 3 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  9: 2 4 hours  TRUE</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 10: 2 5 hours FALSE</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Nicolas Bennett, Drago Plecko, Ida-Fong Ukor.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

